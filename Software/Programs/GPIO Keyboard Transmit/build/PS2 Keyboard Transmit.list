ca65 V2.18 - N/A
Main file   : ./src/GPIO Keyboard Transmit.asm
Current file: ./src/GPIO Keyboard Transmit.asm

000000r 1               .setcpu "65C02"
000000r 1               
000000r 1               .segment "ZEROPAGE"
000000r 1               .segment "STACK"
000000r 1               .segment "INPUT_BUFFER"
000000r 1               .segment "KERNAL_VARS"
000000r 1               .segment "USER_VARS"
000000r 1               .segment "CODE"
000000r 1               
000000r 1               
000000r 1               PORTB   = $9400
000000r 1               PORTA   = $9401
000000r 1               DDRB    = $9402
000000r 1               DDRA    = $9403
000000r 1               
000000r 1               ACIA_DATA   = $9000
000000r 1               ACIA_STATUS = $9001
000000r 1               ACIA_CMD    = $9002
000000r 1               ACIA_CTRL   = $9003
000000r 1               
000000r 1               reset:
000000r 1  A2 FF          ldx #$ff
000002r 1  9A             txs
000003r 1               
000003r 1  A9 00          lda #%00000000         ; Set all pins on port B to inputs
000005r 1  8D 02 94       sta DDRB
000008r 1  A9 00          lda #%00000000         ; Set all pins on port A to inputs
00000Ar 1  8D 03 94       sta DDRA
00000Dr 1               
00000Dr 1  A9 00          lda #$00
00000Fr 1  8D 01 90       sta ACIA_STATUS ; Soft reset (value not important)
000012r 1               
000012r 1  A9 10          lda #%00010000  ; N-8-1, 115200 baud
000014r 1  8D 03 90       sta ACIA_CTRL
000017r 1               
000017r 1  A9 0B          lda #%00001011  ; No parity, No echo, No interrupts
000019r 1  8D 02 90       sta ACIA_CMD
00001Cr 1               
00001Cr 1               loop:
00001Cr 1  A2 0F          ldx #$0F
00001Er 1               loop_inner:
00001Er 1  20 rr rr       jsr delay
000021r 1  CA             dex
000022r 1  D0 FA          bne loop_inner
000024r 1  20 rr rr       jsr scan
000027r 1  4C rr rr       jmp loop
00002Ar 1               
00002Ar 1               scan:
00002Ar 1  A2 80          ldx #$80
00002Cr 1               scan_inner:
00002Cr 1  8E 02 94       stx DDRB        ; Set one of PORTB's pins as output
00002Fr 1  8A             txa
000030r 1  49 FF          eor #$FF        ; Flip all the bits
000032r 1  8D 00 94       sta PORTB       ; Set one of PORTB's pins low to enable column
000035r 1  AD 01 94       lda PORTA       ; Read rows from PORTA
000038r 1  C9 FF          cmp #$FF
00003Ar 1  D0 0E          bne send        ; Output the value of PORTA if any key is pressed
00003Cr 1  A9 00          lda #%00000000  ; Set all pins on port B to inputs
00003Er 1  8D 02 94       sta DDRB
000041r 1  8A             txa
000042r 1  4A             lsr             ; Shift X to the right to set column for next loop
000043r 1  F0 04          beq scan_exit   ; If zero exit scanning
000045r 1  AA             tax
000046r 1  4C rr rr       jmp scan_inner
000049r 1               scan_exit:
000049r 1  60             rts
00004Ar 1               
00004Ar 1               send:
00004Ar 1  20 rr rr       jsr send_value  ; Send value in A register (X = ROW)
00004Dr 1  8A             txa
00004Er 1  20 rr rr       jsr send_value  ; Send value of X register (Y = COL)
000051r 1  60             rts
000052r 1               
000052r 1               delay:
000052r 1  DA             phx
000053r 1  A2 FF          ldx #$ff
000055r 1               delay_loop:
000055r 1  CA             dex
000056r 1  D0 FD          bne delay_loop
000058r 1  FA             plx
000059r 1  60             rts
00005Ar 1               
00005Ar 1               send_value:
00005Ar 1  8D 00 90       sta ACIA_DATA
00005Dr 1  48             pha
00005Er 1               send_value_wait:
00005Er 1  AD 01 90       lda ACIA_STATUS
000061r 1  29 10          and #%00010000        ; Check if tx buffer not empty
000063r 1  F0 F9          beq send_value_wait   ; Loop if tx buffer not empty
000065r 1  68             pla
000066r 1  60             rts
000066r 1               
